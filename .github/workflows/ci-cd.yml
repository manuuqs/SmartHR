name: SmartHR CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build-and-test-backend:
    name: Build and Test Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and Test Backend
        run: |
          cd backend
          mvn clean test
        env:
          JWT_SECRET: test-secret-key-for-ci-pipeline-32-chars-min

      - name: Generate Backend Coverage Report
        run: |
          cd backend
          mvn jacoco:report

      - name: Upload Backend Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: backend-test-results
          path: backend/target/surefire-reports/

      - name: Upload Backend Coverage Report
        uses: actions/upload-artifact@v3
        with:
          name: backend-coverage
          path: backend/target/site/jacoco/

  build-and-test-assistant:
    name: Build and Test IA Assistant
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and Test Assistant
        run: |
          cd assistant
          mvn clean test
        env:
          JWT_SECRET: test-secret-key-for-ci-pipeline-32-chars-min

      - name: Generate Assistant Coverage Report
        run: |
          cd assistant
          mvn jacoco:report

      - name: Upload Assistant Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: assistant-test-results
          path: assistant/target/surefire-reports/

      - name: Upload Assistant Coverage Report
        uses: actions/upload-artifact@v3
        with:
          name: assistant-coverage
          path: assistant/target/site/jacoco/

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_BASE_URL: http://localhost:8080
          VITE_ASSISTANT_BASE_URL: http://localhost:9090

      - name: Upload Frontend Build
        uses: actions/upload-artifact@v3
        with:
          name: frontend-dist
          path: frontend/dist/

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-and-test-backend, build-and-test-assistant, build-frontend]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Backend Image
        run: |
          cd backend
          docker build -t smarthr-backend:latest .

      - name: Build Assistant Image
        run: |
          cd assistant
          docker build -t smarthr-assistant:latest .

      - name: Build Frontend Image
        run: |
          cd frontend
          docker build -t smarthr-frontend:latest .

      - name: Verify Images
        run: |
          docker images | grep smarthr